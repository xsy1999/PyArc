# PyArc
This is a python package for computing absorption and radiative coefficients from first principles based on the scheme proposed by [Xie Zhang *et al.*](https://doi.org/10.1021/acsenergylett.8b01297). The code also offers a series of functions to visualize the calculation results graphically and analyze the microscopic mechanism beneath those results. More details about those functions can be found in our recent paper. 

## Installation
PyArc is implemented in python and can be installed through `pip`.
Dependencies are kept to a minimum and just include standard packages such as `numpy`, `scipy`, and `matplotlib`.

#### With pip
As always with python, it is highly recommended to use a virtual environment.
Install directly from github,
```
$ pip install git+https://github.com/xsy1999/PyArc
```

#### For development
To install PyArc for development purposes, clone the repository
```
$ git clone https://github.com/xsy1999/PyArc
```
then install the package in editable mode with development dependencies
```
$ pip install -r requirements.txt
```

## Usage
A Jupyter notebook is available in the main directory to demonstrate the use of the code for a specific example of GaAs.

The basic steps are summarized below:

0. Perform a first-principles calculation for the target material system. The transmatrix values (Transmatrix file) can be obtained by setting the parameter 'LOPTICS = True' in the INCAR file while using a modified VASP version. The concrete patch file for VASP can be found in the vasp_patch directory and we offered file for different versions.

    To apply the patch file, please download the related 'optics.diff' file into VASP installation directory and use the patch command
    ```
    $patch ./src/linear_optics.F < optics.diff
    ```
    and then recompile VASP. After those steps, one can find the "Transmatrix" file in the calculation directory.

    A good explanation of our methodology can be found in this book [Recombination in Semiconductors](https://doi.org/10.1017/CBO9780511470769). A high-quality first-principles calculation with enough k points for sampling the Brillouin Zone in the electronic self-consistent loop is necessary for accurate absorption and radiative coefficients since too coarse original k-grid in the Brillouin zone may introduce pronounced deviations.

1. Calculate the eigenvalues and transmatrix for a dense k-point grid by using the interpolation method offered in our code. This is facilitated using the `Interp_main.py` function. Through setting relevant parameters like the magnification factor and the valence and conduction band indices to interpolate, the interpolated eigenvalues and transmatrix values will be obtained as `Eigen_geninterp.dat` and `matrix_fine.dat` file respectively. Also, the interpolated kpoints file `wannier90_geninterp.kpt` file will be generated under the path `test_files`
    The way to excute `Interp_main.py` function is as follows (default parameters for testfiles):
    ```
    $python Interp_main.py
    ```
    and also could add some parameters like
    ```
    $python Interp_main.py -VB 34 35 36 -CB 37 38 39 -m 10 10 10
    ```
    1.1 Another way to generate the interpolated eigen values is to utilize the wannier interpolation tools which have been implemented in VASP after Version 5th. Generally the wannier interpolation methods can yield a more precise interpolated results thus significantly improve the accuracy of final results. Concrete instruction and manual of wannier methods in VASP can be found in https://www.vasp.at/wiki/index.php/LWANNIER90 and https://wannier.org/support/
    Here, we also offer the wannier related parameter files `wannier90.win` in the `input_files/wannier` directory (the version of VASP of our example is VASP 5.4.4). 
    concrete steps of wannier interpolation for eigenvalues in VASP are as follows:

    1). prepare the input files (those five files under the `input_files/wannier` directory), and add the parameter `LWANNIER90=.TRUE.` in INCAR file, also set proper parameters in `Wannier90.win` file
   
    2). run VASP; there would be four generated files related to wannier (`Wannier90.wout`, `Wannier90.amn`, `Wannier90.mmn`, `Wannier90.eig`) if run successfully
   
    3). run the wannier order
    ```
    $wannier90.x wannier90
    ```
    after this step, the `Wannier90.chk` file will be generated
   
    4). prepare the interpolated kpoints file (the `wannier90_geninterp.kpt` file generated by our code) and add the parameter `geninterp=true` in `Wannier90.win` file, then run the Post-processing wannier order:
    ```
    postw90.x wannier90
    ```
    after calculation, the final results "wannier90_geninterp.dat" file can be found which could be utilized directly in our code.
   
3. Calculate the absorption and radiative  coefficients. This is facilitated by the `Coefficients_main.py` function. Also, for the calculations of both coefficients, a series of parameters should be delivered to the function according to demands as below. Then files like `Absorption-GaAs.dat` or `Radiative-GaAs_trail.dat` will be generated to store those results.
run with default parameters for test files
    ```
    $python Coefficients_main.py
    ```
    or add parameters like
    ```
    $python Coefficients_main.py -A True -R True -E 1 3 300 # absorption coefficients
    $python Coefficients_main.py -R True -u 3.89 -V 180 -S false -T 100 200 300 # radiative recombinaiton coefficients
    or 
    $python Coefficients_main.py -A True R True -u 1.58 -V 180 -S false -T 100 200 300 # calculate both
    ```

4. Plot the calculation results for absorption and radiative coefficients under different conditions. This is facilitated by the `Figure_main.py` function. It also supports visualization of the carrier density distribution. The way to execute this function is as follows (with default parameters for testfiles):
    ```
    $python Figure_main.py
    ```
    or set parameters like
    ```
    $python Figure_main.py -A True -R True -VB 34 35 36 -CB 37 38 39 -E 1.42
    ```
    users can obtain final results files under the work path they defined
 
5. Users can find the GaAs data as an example in the directory of 'test_files'. And all input files such as KPOINTS can be found in 'input_files' under the 'test_files' directory. The Transmatrix file and Wannier interpolated data files are zipped. The size of the zipped Wannier file is large and please download it seperately.
The easier way to download the Wannier90_geninterp.zip (large size file in github) includes:

    1). In windows system, click the download button under the path https://github.com/xsy1999/PyArc/test_files/wannier90_geninterp.zip or click the prepared released version data path https://github.com/xsy1999/PyArc/releases/download/data/wannier90_geninterp.zip

   2). use the wget or curl order like:
    ```
    $wget -c https://github.com/xsy1999/PyArc/releases/download/data/wannier90_geninterp.zip  #  for linux system
    
    curl -C - -O https://github.com/xsy1999/PyArc/releases/download/data/wannier90_geninterp.zip  #  for windows system
    ```
Then users only need to unzip the wannier90_geninterp.zip file to the directory `test_files`

## Contributing
To contribute, see the above section on installing [for development](#for-development).
Contributions are welcome and any potential change or improvement should be submitted as a pull request on [Github](https://github.com/xsy1999/PyArc/).
Potential contribution areas are:
 - [ ] implement a command line interface
 - [ ] add more robust tests for various functions

#### How to Cite
If you use our code to calculate absorption or radiative  coefficients, please consider citing
```
@article{Xie Zhang_first-principles_2018,
	title = {First-Principles Analysis of Radiative Recombination in Lead-Halide Perovskites},
	volume = {3},
	doi = {10.1021/acsenergylett.8b01297},
	number = {10},
	journal = {ACS Energy Lett.},
	author = {Xie Zhang, Jimmy-Xuan Shen, Wennie Wang, and Chris G. Van de Walle},
	month = sep,
	year = {2018},
	pages = {2329},
}
```
